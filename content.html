<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAYLIFE ‚Äì Gestion du contenu</title>
  <link rel="stylesheet" href="assets/admin.css" />
  <style>
    .content-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 20px;
      margin-top: 20px;
    }

    .content-column {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
    }

    .content-column h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .content-page-select {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .content-page-select select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
    }

    .block-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
      max-height: 420px;
      overflow-y: auto;
    }

    .block-card {
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 10px 12px;
      background: #f8fafc;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .block-type {
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .block-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .small-btn {
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e2e8f0;
      color: #0f172a;
    }

    .small-btn.primary {
      background: #6366f1;
      color: white;
    }

    .small-btn.danger {
      background: #f97373;
      color: white;
    }

    .small-btn.move {
      background: #e0f2fe;
    }

    .block-preview {
      font-size: 0.85rem;
      color: #475569;
    }

    .content-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .content-form label {
      font-size: 0.85rem;
      color: #475569;
      font-weight: 600;
    }

    .content-form input,
    .content-form select,
    .content-form textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: 8px 10px;
      font-size: 0.9rem;
      background: #f8fafc;
    }

    .content-form textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .content-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <!-- üîê Protection admin -->
  <script>
    const role = localStorage.getItem("userRole");
    const isAdmin = localStorage.getItem("adminLoggedIn");
    if (!isAdmin || role !== "admin") {
      window.location.href = "../home.html";
    }
  </script>

  <!-- üåô Menu lat√©ral -->
  <aside class="sidebar hidden" id="sidebar">
    <h1>üåï DAYLIFE Admin</h1>
    <nav class="menu">
      <a href="dashboard.html">üìä Tableau de bord</a>
      <a href="users.html">üë• Utilisateurs</a>
      <a href="settings.html">‚öôÔ∏è Param√®tres</a>
      <a href="content.html" class="active">üß© Contenu</a>
      <a href="../home.html">üè† Application</a>
    </nav>
    <button id="logoutBtn" class="logout-btn">Se d√©connecter</button>
  </aside>

  <!-- üçî Menu burger -->
  <div class="burger" id="burger">
    <span></span><span></span><span></span>
  </div>

  <!-- üåï Contenu principal -->
  <main class="admin-main">
    <header class="admin-top">
      <h2>Gestion du contenu</h2>
    </header>

    <section class="admin-card">
      <div class="content-page-select">
        <label for="pageSelect"><strong>Page cible :</strong></label>
        <select id="pageSelect">
          <option value="home">Accueil (Home)</option>
          <option value="dreams">R√™ves (Dreams)</option>
          <option value="reflections">R√©flexions</option>
          <option value="profile">Profil</option>
          <option value="stars">√âtoiles / Gamification</option>
          <option value="other">Autre / Global</option>
        </select>
        <span class="hint">Chaque page a sa liste de blocs.</span>
      </div>

      <div class="content-layout">
        <!-- Colonne gauche : liste des blocs -->
        <div class="content-column">
          <h3>üìö Blocs existants</h3>
          <p class="hint">
            Voici les √©l√©ments de contenu pour la page s√©lectionn√©e.
            Tu peux les <b>modifier</b>, <b>supprimer</b> ou <b>r√©ordonner</b>.
          </p>
          <div id="blockList" class="block-list"></div>
        </div>

        <!-- Colonne droite : formulaire -->
        <div class="content-column">
          <h3>‚ûï Ajouter / Modifier un bloc</h3>
          <p class="hint">
            Choisis un type (texte, image, vid√©o, bouton, quiz simple), puis remplis les champs.
          </p>

          <form id="contentForm" class="content-form">
            <input type="hidden" id="editingId" />

            <div>
              <label for="blockType">Type de bloc</label>
              <select id="blockType">
                <option value="text">Texte</option>
                <option value="image">Image</option>
                <option value="video">Vid√©o (YouTube / lien)</option>
                <option value="button">Bouton / Lien</option>
                <option value="quiz">Quiz simple</option>
              </select>
            </div>

            <div>
              <label for="blockTitle">Titre / Label</label>
              <input type="text" id="blockTitle" placeholder="Ex : Citation du jour, Section h√©ros..." />
            </div>

            <div>
              <label for="blockBody">Contenu (texte, consignes, question de quiz...)</label>
              <textarea id="blockBody" placeholder="Texte visible pour l'utilisateur"></textarea>
            </div>

            <div>
              <label for="blockMedia">URL (image, vid√©o, lien bouton...)</label>
              <input type="url" id="blockMedia" placeholder="https://‚Ä¶ (optionnel selon le type)" />
              <p class="hint">
                Pour une image : lien de l‚Äôimage. Pour une vid√©o : lien YouTube ou mp4.  
                Pour un bouton : lien de destination (ex : https://daylife.app).
              </p>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-save">üíæ Sauvegarder le bloc</button>
              <button type="button" class="btn-cancel" id="resetForm">üßπ R√©initialiser</button>
            </div>
          </form>
        </div>
      </div>

      <p class="hint" style="margin-top: 16px;">
        üí° Ces donn√©es sont stock√©es localement dans ton navigateur (localStorage).
        Plus tard, on pourra les connecter √† une base de donn√©es r√©elle pour les afficher dans l‚Äôapp.
      </p>
    </section>
  </main>

  <!-- Script commun admin (burger + logout, etc.) -->
  <script src="assets/admin.js"></script>

  <!-- Script sp√©cifique √† la gestion du contenu -->
  <script>
    const STORAGE_KEY = "daylife_content_v1";
    let contentData = {};
    let currentPage = "home";

    const pageSelect = document.getElementById("pageSelect");
    const blockList = document.getElementById("blockList");
    const form = document.getElementById("contentForm");
    const editingIdInput = document.getElementById("editingId");
    const typeInput = document.getElementById("blockType");
    const titleInput = document.getElementById("blockTitle");
    const bodyInput = document.getElementById("blockBody");
    const mediaInput = document.getElementById("blockMedia");
    const resetBtn = document.getElementById("resetForm");

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        contentData = raw ? JSON.parse(raw) : {};
      } catch (e) {
        contentData = {};
      }
      if (!contentData[currentPage]) contentData[currentPage] = [];
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(contentData));
    }

    function renderBlocks() {
      blockList.innerHTML = "";
      const blocks = contentData[currentPage] || [];
      if (blocks.length === 0) {
        blockList.innerHTML = "<p class='hint'>Aucun bloc pour cette page pour l‚Äôinstant.</p>";
        return;
      }

      blocks.forEach((block, index) => {
        const div = document.createElement("div");
        div.className = "block-card";

        const header = document.createElement("div");
        header.className = "block-header";

        const left = document.createElement("div");
        left.innerHTML = `
          <strong>${block.title || "(Sans titre)"} (#${index + 1})</strong>
          <span class="block-type">${block.type}</span>
        `;

        const actions = document.createElement("div");
        actions.className = "block-actions";

        const btnEdit = document.createElement("button");
        btnEdit.className = "small-btn primary";
        btnEdit.textContent = "Modifier";
        btnEdit.onclick = () => editBlock(block.id);

        const btnDel = document.createElement("button");
        btnDel.className = "small-btn danger";
        btnDel.textContent = "Supprimer";
        btnDel.onclick = () => deleteBlock(block.id);

        const btnUp = document.createElement("button");
        btnUp.className = "small-btn move";
        btnUp.textContent = "‚¨ÜÔ∏è";
        btnUp.onclick = () => moveBlock(block.id, -1);

        const btnDown = document.createElement("button");
        btnDown.className = "small-btn move";
        btnDown.textContent = "‚¨áÔ∏è";
        btnDown.onclick = () => moveBlock(block.id, 1);

        actions.appendChild(btnUp);
        actions.appendChild(btnDown);
        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        header.appendChild(left);
        header.appendChild(actions);

        const preview = document.createElement("div");
        preview.className = "block-preview";
        const bodyPreview = block.body ? block.body.slice(0, 120) + (block.body.length > 120 ? "‚Ä¶" : "") : "‚Äî";
        preview.innerHTML = `
          <div><b>Texte :</b> ${bodyPreview}</div>
          ${block.media ? `<div><b>URL :</b> <span>${block.media}</span></div>` : ""}
        `;

        div.appendChild(header);
        div.appendChild(preview);
        blockList.appendChild(div);
      });
    }

    function resetFormState() {
      editingIdInput.value = "";
      form.reset();
      typeInput.value = "text";
    }

    function editBlock(id) {
      const blocks = contentData[currentPage] || [];
      const b = blocks.find(bl => bl.id === id);
      if (!b) return;
      editingIdInput.value = b.id;
      typeInput.value = b.type;
      titleInput.value = b.title || "";
      bodyInput.value = b.body || "";
      mediaInput.value = b.media || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteBlock(id) {
      if (!confirm("Supprimer ce bloc ?")) return;
      const blocks = contentData[currentPage] || [];
      contentData[currentPage] = blocks.filter(bl => bl.id !== id);
      saveData();
      renderBlocks();
    }

    function moveBlock(id, delta) {
      const blocks = contentData[currentPage] || [];
      const index = blocks.findIndex(bl => bl.id === id);
      if (index === -1) return;
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= blocks.length) return;
      const [item] = blocks.splice(index, 1);
      blocks.splice(newIndex, 0, item);
      contentData[currentPage] = blocks;
      saveData();
      renderBlocks();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const type = typeInput.value;
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();
      const media = mediaInput.value.trim();

      const id = editingIdInput.value || String(Date.now());
      const blocks = contentData[currentPage] || [];

      const existingIndex = blocks.findIndex(bl => bl.id === id);
      const newBlock = { id, type, title, body, media };

      if (existingIndex >= 0) {
        blocks[existingIndex] = newBlock;
      } else {
        blocks.push(newBlock);
      }

      contentData[currentPage] = blocks;
      saveData();
      resetFormState();
      renderBlocks();
    });

    resetBtn.addEventListener("click", () => {
      resetFormState();
    });

    pageSelect.addEventListener("change", () => {
      currentPage = pageSelect.value;
      if (!contentData[currentPage]) contentData[currentPage] = [];
      renderBlocks();
    });

    // Init
    loadData();
    renderBlocks();
  </script>
</body>
</html>
