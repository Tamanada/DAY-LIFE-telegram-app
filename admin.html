<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAYLIFE â€” Console Admin (Locale)</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <!-- Barre de navigation -->
  <header class="topbar">
    <div class="logo">
      <span>ğŸŒ™ DAYLIFE Admin</span>
    </div>
    <nav class="desktop-nav">
      <a href="home.html">ğŸ  Home</a>
      <a href="dreams.html">ğŸ’­ Dreams</a>
      <a href="reflections.html">ğŸª Reflections</a>
      <a href="profile.html">ğŸ‘¤ Profile</a>
    </nav>
  </header>

  <main class="admin-page">
    <section class="admin-card admin-header">
      <h1>Console d'administration locale</h1>
      <p>
        Cet outil te permet de gÃ©rer toutes les donnÃ©es <strong>stockÃ©es localement</strong> dans ton navigateur.
        Tu peux modifier le profil, les rÃªves, les rÃ©flexions, exporter ou importer des sauvegardes.
      </p>
      <p class="admin-warning">
        âš ï¸ Rien n'est stockÃ© sur un serveur. Tout reste sur <strong>cet appareil</strong>.
      </p>

      <div class="admin-summary" id="adminSummary"></div>

      <div class="admin-actions">
        <button id="exportBtn" class="primary-btn">ğŸ“¤ Exporter (JSON)</button>
        <label class="file-btn">
          ğŸ“¥ Importer (JSON)
          <input type="file" id="importInput" accept="application/json" hidden />
        </label>
        <button id="resetBtn" class="danger-btn">ğŸ§¨ Effacer tout</button>
      </div>
    </section>

    <!-- Profil -->
    <section class="admin-card">
      <h2>Profil (clÃ© : <code>profile</code>)</h2>
      <p class="small">Modifie ici les donnÃ©es du profil utilisateur stockÃ©es localement.</p>
      <textarea id="profileJson" class="admin-textarea" spellcheck="false"></textarea>
      <div class="admin-actions-row">
        <button id="saveProfileBtn" class="primary-btn">ğŸ’¾ Sauvegarder</button>
        <a href="profile.html" target="_blank" class="link-btn">ğŸ‘€ Voir le profil</a>
      </div>
    </section>

    <!-- RÃªves -->
    <section class="admin-card">
      <h2>RÃªves (clÃ© : <code>dreams</code>)</h2>
      <p class="small">Liste de rÃªves enregistrÃ©s localement.</p>
      <textarea id="dreamsJson" class="admin-textarea" spellcheck="false"></textarea>
      <div class="admin-actions-row">
        <button id="saveDreamsBtn" class="primary-btn">ğŸ’¾ Sauvegarder</button>
        <a href="dreams.html" target="_blank" class="link-btn">ğŸ‘€ Voir les rÃªves</a>
      </div>
    </section>

    <!-- RÃ©flexions -->
    <section class="admin-card">
      <h2>RÃ©flexions (clÃ© : <code>reflections</code>)</h2>
      <p class="small">EntrÃ©es du journal de rÃ©flexion quotidienne.</p>
      <textarea id="reflectionsJson" class="admin-textarea" spellcheck="false"></textarea>
      <div class="admin-actions-row">
        <button id="saveReflectionsBtn" class="primary-btn">ğŸ’¾ Sauvegarder</button>
        <a href="reflections.html" target="_blank" class="link-btn">ğŸ‘€ Voir les rÃ©flexions</a>
      </div>
    </section>
  </main>

  <script>
    function safeParse(text, fallback) {
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("JSON parse error:", e);
        return fallback;
      }
    }

    function pretty(value) {
      return JSON.stringify(value, null, 2);
    }

    function loadData() {
      const profile = safeParse(localStorage.getItem("profile") || "null", null);
      const dreams = safeParse(localStorage.getItem("dreams") || "[]", []);
      const reflections = safeParse(localStorage.getItem("reflections") || "[]", []);

      document.getElementById("profileJson").value = profile ? pretty(profile) : "";
      document.getElementById("dreamsJson").value = pretty(dreams);
      document.getElementById("reflectionsJson").value = pretty(reflections);

      const summary = document.getElementById("adminSummary");
      const name = profile?.name || "Inconnu";
      const stars = profile?.totalStars || 0;
      const streak = profile?.streakDays || 0;

      summary.innerHTML = `
        <div class="admin-summary-grid">
          <div><div class="label">Nom</div><div class="value">${name}</div></div>
          <div><div class="label">Ã‰toiles</div><div class="value">â­ ${stars}</div></div>
          <div><div class="label">Streak</div><div class="value">ğŸ”¥ ${streak} jours</div></div>
          <div><div class="label">RÃªves</div><div class="value">${dreams.length}</div></div>
          <div><div class="label">RÃ©flexions</div><div class="value">${reflections.length}</div></div>
          <div><div class="label">ClÃ©s localStorage</div><div class="value">${Object.keys(localStorage).length}</div></div>
        </div>`;
    }

    function saveKeyFromTextarea(key, textareaId) {
      const raw = document.getElementById(textareaId).value.trim();
      if (!raw) {
        if (!confirm("Le contenu est vide. Supprimer la clÃ© '" + key + "' ?")) return;
        localStorage.removeItem(key);
        alert("ClÃ© '" + key + "' supprimÃ©e.");
        loadData();
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        localStorage.setItem(key, JSON.stringify(parsed));
        alert("âœ… DonnÃ©es sauvegardÃ©es pour '" + key + "'.");
        loadData();
      } catch (e) {
        alert("Erreur JSON : " + e.message);
      }
    }

    function exportAll() {
      const data = {
        profile: safeParse(localStorage.getItem("profile") || "null", null),
        dreams: safeParse(localStorage.getItem("dreams") || "[]", []),
        reflections: safeParse(localStorage.getItem("reflections") || "[]", [])
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "daylife-backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importAll(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (data.profile) localStorage.setItem("profile", JSON.stringify(data.profile));
          if (data.dreams) localStorage.setItem("dreams", JSON.stringify(data.dreams));
          if (data.reflections) localStorage.setItem("reflections", JSON.stringify(data.reflections));
          alert("âœ… Import terminÃ© !");
          loadData();
        } catch (e) {
          alert("âŒ Fichier invalide : " + e.message);
        }
      };
      reader.readAsText(file);
    }

    function resetAll() {
      if (confirm("âš ï¸ Cela va effacer TOUT le localStorage pour ce domaine. Continuer ?")) {
        localStorage.clear();
        alert("ğŸ§¨ localStorage vidÃ© !");
        loadData();
      }
    }

    // Brancher les boutons
    document.getElementById("saveProfileBtn").addEventListener("click", () => saveKeyFromTextarea("profile", "profileJson"));
    document.getElementById("saveDreamsBtn").addEventListener("click", () => saveKeyFromTextarea("dreams", "dreamsJson"));
    document.getElementById("saveReflectionsBtn").addEventListener("click", () => saveKeyFromTextarea("reflections", "reflectionsJson"));
    document.getElementById("exportBtn").addEventListener("click", exportAll);
    document.getElementById("resetBtn").addEventListener("click", resetAll);

    document.getElementById("importInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) importAll(file);
    });

    loadData();
  </script>
</body>
</html>
