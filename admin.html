<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAYLIFE ‚Äî Admin Console</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <header class="topbar admin-topbar">
    <div class="logo">
      <img src="assets/logo.png" alt="DAYLIFE Logo" />
      <span>DAYLIFE Admin</span>
    </div>
  </header>

  <main class="admin-page">
    <!-- Overview -->
    <section class="admin-section">
      <h1>Admin Console (local)</h1>
      <p class="admin-muted">
        Cette console lit et modifie les donn√©es stock√©es localement dans votre navigateur
        (profile, r√™ves, r√©flexions).
      </p>

      <div class="admin-grid">
        <div class="admin-card">
          <h3>Profil</h3>
          <p><strong id="ovName">-</strong></p>
          <p id="ovEmail" class="admin-muted">-</p>
          <p>
            ‚≠ê <span id="ovStars">0</span> √©toiles &nbsp; ‚Ä¢ &nbsp;
            üî• <span id="ovStreak">0</span> jours de suite
          </p>
        </div>

        <div class="admin-card">
          <h3>R√™ves</h3>
          <p>Total : <strong id="ovDreamsTotal">0</strong></p>
          <p>
            En cours : <strong id="ovDreamsActive">0</strong><br />
            Termin√©s : <strong id="ovDreamsDone">0</strong>
          </p>
        </div>

        <div class="admin-card">
          <h3>R√©flexions</h3>
          <p>Total : <strong id="ovReflections">0</strong></p>
          <p class="admin-muted">Journal quotidien de l'utilisateur.</p>
        </div>

        <div class="admin-card">
          <h3>R√©f√©rences</h3>
          <p>Parrainages : <strong id="ovRefFriends">0</strong></p>
          <p>√âtoiles par parrainage : <strong>5 ‚≠ê</strong></p>
          <p>Total √©toiles parrainage : <strong id="ovRefStars">0</strong></p>
        </div>
      </div>
    </section>

    <!-- Profile management -->
    <section class="admin-section">
      <h2>Gestion du profil (localStorage: "profile")</h2>

      <div class="admin-form-grid">
        <div class="admin-card">
          <h3>Donn√©es principales</h3>
          <label>Nom</label>
          <input id="adminNameInput" type="text" placeholder="Nom" />

          <label>Email</label>
          <input id="adminEmailInput" type="email" placeholder="vous@example.com" />

          <label>Date de naissance</label>
          <input id="adminBirthInput" type="date" />

          <label>Sexe</label>
          <select id="adminSexSelect">
            <option value="male">Homme</option>
            <option value="female">Femme</option>
          </select>

          <label>Pays (code)</label>
          <input id="adminCountryInput" type="text" placeholder="FR, US, TH..." />

          <label>Th√®me</label>
          <select id="adminThemeSelect">
            <option value="light">Clair</option>
            <option value="dark">Sombre</option>
            <option value="lunar">Lunaire</option>
          </select>
        </div>

        <div class="admin-card">
          <h3>Progression & parrainage</h3>
          <label>√âtoiles (totalStars)</label>
          <input id="adminStarsInput" type="number" min="0" />

          <label>Streak (streakDays)</label>
          <input id="adminStreakInput" type="number" min="0" />

          <label>Code parrainage (referralCode)</label>
          <input id="adminRefCodeInput" type="text" readonly />

          <label>Amis parrain√©s (referralFriends)</label>
          <input id="adminRefFriendsInput" type="number" min="0" />

          <button id="adminProfileSaveBtn" class="primary-btn full-width">
            üíæ Enregistrer le profil
          </button>
        </div>
      </div>
    </section>

    <!-- Dreams management -->
    <section class="admin-section">
      <h2>R√™ves (localStorage: "dreams")</h2>
      <p class="admin-muted">
        Liste brute des r√™ves stock√©s localement. Cette console suppose que le format est
        similaire √† celui utilis√© dans la page Dreams : { title, status, deadline, ... }.
      </p>

      <div id="dreamsContainer" class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Titre</th>
              <th>Statut</th>
              <th>Deadline</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dreamsTableBody">
            <!-- rempli en JS -->
          </tbody>
        </table>
      </div>

      <button id="adminDreamsClearBtn" class="danger-btn">
        üóëÔ∏è Supprimer tous les r√™ves (local)
      </button>
    </section>

    <!-- Reflections management -->
    <section class="admin-section">
      <h2>R√©flexions (localStorage: "reflections")</h2>
      <p class="admin-muted">
        Chaque r√©flexion est enregistr√©e comme { text, date }. La console vous permet de les
        visualiser et de les supprimer.
      </p>

      <div id="reflectionsContainer" class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Texte</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reflectionsTableBody">
            <!-- rempli en JS -->
          </tbody>
        </table>
      </div>

      <button id="adminReflectionsClearBtn" class="danger-btn">
        üóëÔ∏è Supprimer toutes les r√©flexions (local)
      </button>
    </section>

    <!-- Global actions -->
    <section class="admin-section">
      <h2>Export & R√©initialisation</h2>

      <div class="admin-actions-row">
        <button id="adminExportBtn" class="primary-btn">
          ‚¨áÔ∏è Exporter les donn√©es (JSON)
        </button>
        <button id="adminResetAllBtn" class="danger-btn">
          ‚ö†Ô∏è Reset complet du localStorage
        </button>
      </div>

      <p class="admin-muted tiny-text">
        Attention : le reset complet efface toutes les donn√©es de DAYLIFE sur cet appareil
        (profil, r√™ves, r√©flexions, param√®tres).
      </p>
    </section>
  </main>

  <script>
    // R√©cup√©ration / sauvegarde profil
    const defaultProfile = {
      name: "David",
      email: "",
      avatar: "assets/avatar.png",
      totalStars: 0,
      streakDays: 0,
      birthdate: "",
      sex: "male",
      country: "",
      lifeMode: "30000_days",
      theme: "light",
      referralCode: null,
      referralFriends: 0
    };

    function loadProfile() {
      let p = JSON.parse(localStorage.getItem("profile")) || defaultProfile;
      if (!p.referralCode) {
        p.referralCode =
          "DAY" + Math.random().toString(36).substring(2, 8).toUpperCase();
      }
      return p;
    }

    function saveProfile(profile) {
      localStorage.setItem("profile", JSON.stringify(profile));
    }

    function loadDreams() {
      return JSON.parse(localStorage.getItem("dreams")) || [];
    }

    function saveDreams(dreams) {
      localStorage.setItem("dreams", JSON.stringify(dreams));
    }

    function loadReflections() {
      return JSON.parse(localStorage.getItem("reflections")) || [];
    }

    function saveReflections(reflections) {
      localStorage.setItem("reflections", JSON.stringify(reflections));
    }

    // --- Rendu de la console ---
    let profile = loadProfile();
    let dreams = loadDreams();
    let reflections = loadReflections();

    function renderOverview() {
      const activeDreams = dreams.filter((d) => d.status === "in_progress").length;
      const doneDreams = dreams.filter((d) => d.status === "completed").length;

      document.getElementById("ovName").textContent = profile.name || "-";
      document.getElementById("ovEmail").textContent = profile.email || "-";
      document.getElementById("ovStars").textContent = profile.totalStars || 0;
      document.getElementById("ovStreak").textContent = profile.streakDays || 0;

      document.getElementById("ovDreamsTotal").textContent = dreams.length;
      document.getElementById("ovDreamsActive").textContent = activeDreams;
      document.getElementById("ovDreamsDone").textContent = doneDreams;

      document.getElementById("ovReflections").textContent = reflections.length;
      document.getElementById("ovRefFriends").textContent =
        profile.referralFriends || 0;
      document.getElementById("ovRefStars").textContent =
        (profile.referralFriends || 0) * 5;
    }

    function renderProfileForm() {
      document.getElementById("adminNameInput").value = profile.name || "";
      document.getElementById("adminEmailInput").value = profile.email || "";
      document.getElementById("adminBirthInput").value = profile.birthdate || "";
      document.getElementById("adminSexSelect").value = profile.sex || "male";
      document.getElementById("adminCountryInput").value = profile.country || "";
      document.getElementById("adminThemeSelect").value = profile.theme || "light";
      document.getElementById("adminStarsInput").value = profile.totalStars || 0;
      document.getElementById("adminStreakInput").value = profile.streakDays || 0;
      document.getElementById("adminRefCodeInput").value =
        profile.referralCode || "";
      document.getElementById("adminRefFriendsInput").value =
        profile.referralFriends || 0;
    }

    function renderDreamsTable() {
      const tbody = document.getElementById("dreamsTableBody");
      tbody.innerHTML = "";

      dreams.forEach((dream, index) => {
        const tr = document.createElement("tr");

        const title = dream.title || "(Sans titre)";
        const status = dream.status || "unknown";
        const deadline = dream.deadline || dream.dueDate || "-";

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${title}</td>
          <td>
            <select data-index="${index}" class="dream-status-select">
              <option value="in_progress" ${
                status === "in_progress" ? "selected" : ""
              }>En cours</option>
              <option value="completed" ${
                status === "completed" ? "selected" : ""
              }>Termin√©</option>
              <option value="unknown" ${
                status !== "in_progress" && status !== "completed" ? "selected" : ""
              }>Inconnu</option>
            </select>
          </td>
          <td>${deadline}</td>
          <td>
            <button data-index="${index}" class="dream-delete-btn">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // listeners pour les s√©lecteurs de statut
      document.querySelectorAll(".dream-status-select").forEach((select) => {
        select.addEventListener("change", (e) => {
          const i = parseInt(e.target.getAttribute("data-index"), 10);
          dreams[i].status = e.target.value;
          saveDreams(dreams);
          renderOverview();
        });
      });

      // listeners pour supprimer un r√™ve
      document.querySelectorAll(".dream-delete-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const i = parseInt(e.target.getAttribute("data-index"), 10);
          if (confirm("Supprimer ce r√™ve ?")) {
            dreams.splice(i, 1);
            saveDreams(dreams);
            dreams = loadDreams();
            renderDreamsTable();
            renderOverview();
          }
        });
      });
    }

    function renderReflectionsTable() {
      const tbody = document.getElementById("reflectionsTableBody");
      tbody.innerHTML = "";

      reflections.forEach((ref, index) => {
        const dateLabel = ref.date
          ? new Date(ref.date).toLocaleDateString()
          : "-";
        const text = ref.text || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${dateLabel}</td>
          <td class="admin-ref-text">${text}</td>
          <td>
            <button data-index="${index}" class="ref-delete-btn">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".ref-delete-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const i = parseInt(e.target.getAttribute("data-index"), 10);
          if (confirm("Supprimer cette r√©flexion ?")) {
            reflections.splice(i, 1);
            saveReflections(reflections);
            reflections = loadReflections();
            renderReflectionsTable();
            renderOverview();
          }
        });
      });
    }

    // --- √âcouteurs ---

    document
      .getElementById("adminProfileSaveBtn")
      .addEventListener("click", () => {
        profile.name = document.getElementById("adminNameInput").value.trim();
        profile.email = document
          .getElementById("adminEmailInput")
          .value.trim();
        profile.birthdate =
          document.getElementById("adminBirthInput").value || "";
        profile.sex = document.getElementById("adminSexSelect").value;
        profile.country = document
          .getElementById("adminCountryInput")
          .value.toUpperCase();
        profile.theme = document.getElementById("adminThemeSelect").value;
        profile.totalStars = parseInt(
          document.getElementById("adminStarsInput").value || "0",
          10
        );
        profile.streakDays = parseInt(
          document.getElementById("adminStreakInput").value || "0",
          10
        );
        profile.referralFriends = parseInt(
          document.getElementById("adminRefFriendsInput").value || "0",
          10
        );

        saveProfile(profile);
        profile = loadProfile();
        renderOverview();
        renderProfileForm();
        alert("Profil enregistr√© dans localStorage ‚úÖ");
      });

    // Clear dreams
    document
      .getElementById("adminDreamsClearBtn")
      .addEventListener("click", () => {
        if (
          confirm(
            "Supprimer tous les r√™ves stock√©s localement ? (Cette action est irr√©versible)"
          )
        ) {
          dreams = [];
          saveDreams(dreams);
          renderDreamsTable();
          renderOverview();
        }
      });

    // Clear reflections
    document
      .getElementById("adminReflectionsClearBtn")
      .addEventListener("click", () => {
        if (
          confirm(
            "Supprimer toutes les r√©flexions stock√©es localement ? (Cette action est irr√©versible)"
          )
        ) {
          reflections = [];
          saveReflections(reflections);
          renderReflectionsTable();
          renderOverview();
        }
      });

    // Export data
    document.getElementById("adminExportBtn").addEventListener("click", () => {
      const data = {
        profile,
        dreams,
        reflections
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "daylife-data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Reset all
    document
      .getElementById("adminResetAllBtn")
      .addEventListener("click", () => {
        if (
          confirm(
            "‚ö†Ô∏è Cela va effacer TOUTES les donn√©es DAYLIFE stock√©es localement sur cet appareil. Continuer ?"
          )
        ) {
          localStorage.clear();
          alert("LocalStorage effac√©. La page va se recharger.");
          window.location.reload();
        }
      });

    // initial render
    renderOverview();
    renderProfileForm();
    renderDreamsTable();
    renderReflectionsTable();
  </script>
</body>
</html>
